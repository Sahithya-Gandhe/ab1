// =============================================================================
// SECOND-PRICE DOUBLE AUCTION SYSTEM - DATABASE SCHEMA
// =============================================================================
// Multi-buyer, multi-seller auction with Excel-exact market clearing logic
// Implements: Cumulative supply/demand, gap analysis, second-price incentives
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// 1️⃣ AUCTION - Stores auction instance state
// =============================================================================
model Auction {
  id                 String   @id @default(cuid())
  status             AuctionStatus @default(DRAFT)
  
  // Clearing results
  clearingPrice      Decimal?  @db.Decimal(12, 4)
  clearingQuantityMt Decimal?  @db.Decimal(12, 4)
  tradeValue         Decimal?  @db.Decimal(18, 4)
  
  // Supply/Demand totals
  totalSupplyMt      Decimal?  @db.Decimal(12, 4)
  totalDemandMt      Decimal?  @db.Decimal(12, 4)
  unsoldSupplyMt     Decimal?  @db.Decimal(12, 4)
  
  // Re-auction tracking
  reauctionCount     Int       @default(0)
  parentAuctionId    String?
  parentAuction      Auction?  @relation("ReAuction", fields: [parentAuctionId], references: [id])
  childAuctions      Auction[] @relation("ReAuction")
  
  // Configuration
  tickSize           Decimal   @default(0.01) @db.Decimal(8, 4)
  clearingType       String?   // EXACT | INTERPOLATED | NO_CLEARING
  
  // Timestamps
  createdAt          DateTime  @default(now())
  startTime          DateTime?
  endTime            DateTime?
  closedAt           DateTime?
  
  // Relations
  buyerBids          BuyerBid[]
  sellerBids         SellerBid[]
  allocations        Allocation[]
  supplySnapshots    AuctionSupplySnapshot[]
  marketDemand       MarketDemand[]
  buyerSellerDistances BuyerSellerDistance[]
  gapSnapshots       AuctionGapSnapshot[]
  
  @@map("auctions")
}

enum AuctionStatus {
  DRAFT
  PENDING
  ACTIVE
  CLOSED
  COMPLETED
  REAUCTION
  CANCELLED
}

// =============================================================================
// 2️⃣ BUYER - Represents buyer entities
// =============================================================================
model Buyer {
  id           String   @id @default(cuid())
  buyerName    String
  organization String?
  creditLimit  Decimal? @db.Decimal(18, 4)
  email        String   @unique
  password     String
  createdAt    DateTime @default(now())
  latitude     Decimal? @db.Decimal(9, 6)
  longitude    Decimal? @db.Decimal(9, 6)
  userId       String?  @unique
  user         User?    @relation(fields: [userId], references: [id])
  
  // Relations
  bids         BuyerBid[]
  allocations  Allocation[]
  buyerSellerDistances BuyerSellerDistance[]
  
  @@map("buyers")
}

// =============================================================================
// 3️⃣ SELLER - Represents seller entities
// =============================================================================
model Seller {
  id               String   @id @default(cuid())
  sellerName       String
  location         String?
  // Coordinates for distance calculation (buyer-relative)
  latitude         Decimal? @db.Decimal(9, 6)
  longitude        Decimal? @db.Decimal(9, 6)
  userId           String?  @unique
  user             User?    @relation(fields: [userId], references: [id])
  
  // Default offer values (used when creating auction)
  basePricePerKg   Decimal? @db.Decimal(10, 4)  // Base offer price
  offerQuantityMt  Decimal? @db.Decimal(12, 4)  // Total quantity offered
  
  createdAt        DateTime @default(now())
  
  // Relations
  bids         SellerBid[]
  allocations  Allocation[]
  buyerSellerDistances BuyerSellerDistance[]
  
  @@map("sellers")
}

// =============================================================================
// 4️⃣ BUYER_BIDS - Multiple price-quantity bids per buyer per auction
// =============================================================================
// Rules:
// - Buyers may submit multiple bids for different distance slabs
// - Each distance slab can have up to 3 price-quantity bids
// - Sorted by price DESC for clearing
// - Cumulative demand calculated bottom → top
// - When buyer quantities end, cumulative demand repeats upward
// =============================================================================
model BuyerBid {
  id                  String   @id @default(cuid())
  auctionId           String
  auction             Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  buyerId             String
  buyer               Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  // Distance slab info - reference to DistanceSlab (single source of truth)
  distanceSlabId      String?  // Reference to which distance slab
  distanceSlab        DistanceSlab? @relation(fields: [distanceSlabId], references: [id])
  
  bidPricePerKg       Decimal  @db.Decimal(10, 4)
  bidQuantityMt       Decimal  @db.Decimal(12, 4)
  cumulativeDemandMt  Decimal? @db.Decimal(12, 4) // Calculated during clearing
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([auctionId])
  @@index([buyerId])
  @@index([auctionId, bidPricePerKg(sort: Desc)])
  @@index([auctionId, distanceSlabId])
  @@unique([auctionId, buyerId, bidPricePerKg, distanceSlabId])
  @@map("buyer_bids")
}

// =============================================================================
// 5️⃣ SELLER_BIDS - Multiple supply slabs per seller per auction
// =============================================================================
// Rules:
// - Sellers may submit multiple price-quantity slabs
// - Sorted by offer price ASC
// - Cumulative supply calculated top → bottom
// - landed_cost = offer_price + delivery_cost
// =============================================================================
model SellerBid {
  id                  String   @id @default(cuid())
  auctionId           String
  auction             Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  sellerId            String
  seller              Seller   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  offerPricePerKg     Decimal  @db.Decimal(10, 4)
  offerQuantityMt     Decimal  @db.Decimal(12, 4)
  // Distance/delivery/landed cost are buyer-relative and computed at allocation time
  // They MUST NOT be stored on SellerBid to preserve price-only clearing
  cumulativeSupplyMt  Decimal? @db.Decimal(12, 4) // Calculated during clearing
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([auctionId])
  @@index([sellerId])
  @@index([auctionId, offerPricePerKg(sort: Asc)])
  @@unique([auctionId, sellerId, offerPricePerKg])
  @@map("seller_bids")
}

// =============================================================================
// BuyerSellerDistance - Derived & cached buyer<->seller distances per auction
// This is computed once per auction and used during allocation and UI display
// =============================================================================
model BuyerSellerDistance {
  id            String   @id @default(cuid())
  auctionId     String
  auction       Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  buyerId       String
  buyer         Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId      String
  seller        Seller   @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  distanceKm    Decimal  @db.Decimal(10, 2)
  slabId        String
  slab          DistanceSlab @relation(fields: [slabId], references: [id])
  costPerKg     Decimal  @db.Decimal(10, 4)

  createdAt     DateTime @default(now())

  @@unique([auctionId, buyerId, sellerId])
  @@index([auctionId])
  @@map("buyer_seller_distances")
}

// =============================================================================
// 6️⃣ DISTANCE_SLABS - Fixed delivery pricing
// =============================================================================
model DistanceSlab {
  id          String   @id @default(cuid())
  minKm       Decimal  @db.Decimal(10, 2)
  maxKm       Decimal  @db.Decimal(10, 2)
  costPerKg   Decimal  @db.Decimal(10, 4)
  createdAt   DateTime @default(now())
  buyerBids    BuyerBid[]
  buyerSellerDistances BuyerSellerDistance[]
  
  @@map("distance_slabs")
}

// =============================================================================
// 7️⃣ ALLOCATIONS - Final auction result mapping buyers to sellers
// =============================================================================
model Allocation {
  id                  String   @id @default(cuid())
  auctionId           String
  auction             Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  buyerId             String
  buyer               Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId            String
  seller              Seller   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  allocatedQuantityMt Decimal  @db.Decimal(12, 4)
  finalPricePerKg     Decimal  @db.Decimal(10, 4) // Clearing price (second-price)
  
  // Additional details for audit
  buyerBidPrice       Decimal? @db.Decimal(10, 4)
  sellerOfferPrice    Decimal? @db.Decimal(10, 4)
  sellerLandedCost    Decimal? @db.Decimal(10, 4)
  tradeValue          Decimal? @db.Decimal(18, 4)
  buyerSavings        Decimal? @db.Decimal(18, 4) // bid_price - clearing_price
  sellerBonus         Decimal? @db.Decimal(18, 4) // clearing_price - offer_price
  
  createdAt           DateTime @default(now())
  
  @@index([auctionId])
  @@index([buyerId])
  @@index([sellerId])
  @@map("allocations")
}

// =============================================================================
// 8️⃣ MARKET_DEMAND - Price-aggregated demand curve for Excel-exact clearing
// =============================================================================
// This is THE demand table used for cumulative demand and clearing.
// Aggregates all buyer bids at each price point (total demand across buyers).
// Cumulative demand calculated BOTTOM → TOP on this table.
// Individual BuyerBid table is used ONLY for allocation after clearing.
model MarketDemand {
  id                  String   @id @default(cuid())
  auctionId           String
  auction             Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  
  pricePerKg          Decimal  @db.Decimal(10, 4)
  totalDemandMt       Decimal  @db.Decimal(12, 4) // Sum of all buyer quantities at this price
  cumulativeDemandMt  Decimal? @db.Decimal(12, 4) // Calculated bottom → top
  
  @@index([auctionId, pricePerKg(sort: Desc)])
  @@map("market_demand")
}

// =============================================================================
// AUDIT SNAPSHOTS - Supply, Demand, Gap snapshots for Excel matching
// =============================================================================

model AuctionSupplySnapshot {
  id                String   @id @default(cuid())
  auctionId         String
  auction           Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  
  sellerId          String
  sellerName        String
  price             Decimal  @db.Decimal(10, 4)
  quantity          Decimal  @db.Decimal(12, 4)
  cumulativeSupply  Decimal  @db.Decimal(12, 4)
  landedCost        Decimal? @db.Decimal(10, 4)
  deliveryCost      Decimal? @db.Decimal(10, 4)
  
  @@index([auctionId])
  @@map("auction_supply_snapshots")
}

// AuctionDemandSnapshot removed - replaced by MarketDemand table
// Individual buyer bid details are in BuyerBid table (used for allocation only)

model AuctionGapSnapshot {
  id                String   @id @default(cuid())
  auctionId         String
  auction           Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  
  rowIndex          Int
  price             Decimal  @db.Decimal(10, 4)
  supply            Decimal  @db.Decimal(12, 4)
  demand            Decimal  @db.Decimal(12, 4)
  gap               Decimal  @db.Decimal(12, 4)
  
  @@index([auctionId])
  @@map("auction_gap_snapshots")
}

// =============================================================================
// USER - Authentication (kept for backward compatibility)
// =============================================================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(BUYER)
  createdAt DateTime @default(now())
  buyer     Buyer?
  seller    Seller?
  
  @@map("users")
}

enum UserRole {
  ADMIN
  BUYER
  SELLER
}
